# Сервер Express API

## Содержание

1. [Установка и запуск сервера](#установка-и-запуск-сервера)

2. [Роутинг](#роутинг)

   - [Маршруты аутентификации /auth](#маршруты-аутентификации-auth)
   - [Маршруты геоданных /geo](#маршруты-геоданных-geo)
   - [Маршруты пользователей /user](#маршруты-пользователей-user)
   - [Маршруты лайков /likes](#маршруты-лайков-likes)

3. [Структура базы данных](#модели-данных)

## Установка и запуск сервера

### Предварительные требования

- Node.js v18+
- PostgreSQL
- Установленный Prisma CLI

### 1. Установка зависимостей

```bash
npm install
```

### 2. Настройка окружения

Создайте файл `.env` в корне проекта и заполните по примеру:

```env
DATABASE_URL="postgresql://user:password@localhost:5432/dbname"
JWT_SECRET="your_jwt_secret_key"
```

### 3. Запуск сервера

**Dev режим (с hot-reload):**

```bash
npm run dev
```

**Production режим:**

```bash
npm start
```

## Работа с базой данных

### Инициализация Prisma

Перед первым запуском выполните:

```bash
npx prisma db push
```

### Рекомендации по разработке

1. Для новых миграций:

```bash
npx prisma migrate dev --name your_migration_name
```

2. Для просмотра базы данных:

```bash
npx prisma studio
```

3. При добавлении новых полей в модели:

- Сначала обновите `schema.prisma`
- Затем выполните миграцию
- Генерируйте клиент Prisma заново

Сервер будет доступен по адресу: `http://localhost:3000`


### Скрипты для работы с данными

**Импорт спортивных объектов Москвы:**

```bash
npm run sports
```

_Заполняет базу официальными данными спортивных площадок_

**Генерация тестовых данных:**

```bash
npm run fake
```

_Создает:_

- 1000 тестовых пользователей
- 1000 карточек тренировок

**Очистка базы данных:**

```bash
npm run clear
```

_Удаляет все пользовательские данные, оставляя только спортивные объекты_

### Форматирование кода

Для поддержания единого стиля:

```bash
npm run format
```

### Структура проекта

Основные директории:

- `src/api/` - API роуты, middleware
- `src/core/` - Бизнес-логика
- `src/utils/` - Вспомогательные утилиты
  - `scripts/` - Скрипты для работы с данными
- `prisma/` - Схема базы данных

## Роутинг

### Маршруты аутентификации `/auth`

#### `POST /signup`

- **Назначение**: Регистрация нового пользователя
- **Параметры запроса**:
  ```json
  {
    "email": "string",
    "password": "string"
  }
  ```
- **Ответы**:
  - `200 OK`: Успешная регистрация
  - `400 Bad Request`: Невалидные данные
  - `409 Conflict`: Email уже занят

#### `POST /login`

- **Назначение**: Аутентификация пользователя
- **Параметры запроса**:
  ```json
  {
    "email": "string",
    "password": "string"
  }
  ```
- **Ответы**:
  - `200 OK`: Успешный вход (устанавливает HTTP-only cookie `access_token`)
  - `401 Unauthorized`: Неверные учетные данные

#### `GET /validate-access-token`

- **Назначение**: Проверка валидности токена
- **Ответы**:
  - `200 OK`: Токен валиден (возвращает данные пользователя)
  - `401 Unauthorized`: Токен невалиден

#### `GET /logout`

- **Назначение**: Выход из системы
- **Ответ**: `200 OK` (очищает cookie `access_token`)

### Маршруты геоданных `/geo`

#### `GET /markers`

- **Назначение**: Получение списка спортивных объектов
- **Ответ**: `200 OK` со списком объектов

### Маршруты пользователей `/user`

#### `POST /create-card`

- **Назначение**: Создание новой карточки
- **Ответ**: `201 Created` при успешном создании

#### `GET /cards`

- **Назначение**: Получение карточек пользователя
- **Ответ**: `200 OK` со списком карточек

#### `GET /likes`

- **Назначение**: Получение карточек пользователей
- **Ответ**: `200 OK` со списком карточек пользователей, которые лайкнули карточку текущего пользователя

#### `GET /contacts`

- **Назначение**: Получение карточек пользователей с контактной информацией
- **Ответ**: `200 OK` со списком карточек пользователей, взаимно лайкнувших друг друга

### Маршруты лайков `/likes`

#### `POST /like`

- **Назначение**: Поставить лайк карточке
- **Ответ**: `200 OK` при успехе

#### `POST /dislike`

- **Назначение**: Поставить дизлайк карточке
- **Ответ**: `200 OK` при успехе

## Модели данных

### Location (Локация)

Хранит географические координаты спортивных объектов.

**Поля:**

- `id` - UUID первичный ключ
- `x` - Координата широты (Float)
- `y` - Координата долготы (Float)
- `SportsObject` - Связь с SportsObject

### Schedule (Расписание)

Определяет удобное расписание пользователя.

**Поля:**

- `id` - UUID первичный ключ
- `dayOfWeek` - День недели (String)
- `startTime` - Время начала тренировки (String)
- `endTime` - Время окончания тренировки (String)
- `card` - Связь с моделью Card
- `cardId` - Внешний ключ для связи с Card

### User (Пользователь)

Содержит данные зарегистрированных пользователей.

**Поля:**

- `id` - UUID первичный ключ
- `hashedPassword` - Хэшированный пароль
- `email` - Уникальный email (макс. 255 символов)
- `phone` - Телефон (опционально, макс. 20 символов)
- `tgUsername` - Telegram username (опционально)
- `name` - Имя пользователя (опционально)
- `age` - Возраст (опционально)
- `card` - Связь с Card (опционально)
- `UserLikedCards` - Связь с лайками
- `UserDislikedCards` - Связь с дизлайками

### Card (Карточка)

Основная сущность для работы с объектами.

**Поля:**

- `id` - UUID первичный ключ
- `likedBy` - Связь с пользователями, лайкнувшими карточку
- `dislikedBy` - Связь с пользователями, дизлайкнувшими карточку
- `schedules` - Связь с расписаниями
- `SportsObject_CardAddedObjects` - Связь с спортивными объектами
- `author` - Связь с автором (User)
- `authorId` - Внешний ключ для связи с User (уникальный)

### UserLikedCards (Лайки)

Фиксирует лайки пользователей.

**Поля:**

- `id` - UUID первичный ключ
- `user` - Связь с User
- `userId` - Внешний ключ
- `card` - Связь с Card
- `cardId` - Внешний ключ
- `createdAt` - Дата создания (автоматически)

### UserDislikedCards (Дизлайки)

Фиксирует дизлайки пользователей.

**Поля:** (аналогично UserLikedCards)

### SportsObject (Спортивный объект)

Содержит детальную информацию об объектах.

**Основные поля:**

- `global_id` - Первичный ключ
- `Card_CardAddedObjects` - Связь с карточками
- `location` - Связь с Location
- `locationId` - Внешний ключ (уникальный)

**Дополнительные атрибуты:**

- Названия (`ObjectName`, `NameWinter`)
- Адресные данные (`AdmArea`, `District`, `Address`)
- Контакты (`Email`, `WebSite`, `HelpPhone`)
- Удобства (`HasToilet`, `HasWifi`, `HasFirstAidPost`)
- Характеристики (`DimensionsWinter`, `Lighting`)
- Условия (`Paid`, `DisabilityFriendly`)

## Особенности реализации

1. Используется PostgreSQL в качестве СУБД
2. Все ID генерируются как UUID
3. Для хранения паролей используется хэширование
4. Поддержка лайков/дизлайков с временными метками
